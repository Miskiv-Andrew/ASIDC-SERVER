1. ОБЩАЯ АРХИТЕКТУРА СИСТЕМЫ
1.1. Компоненты системы
ServerCore — ядро HTTP/HTTPS сервера
Назначение: Обработка входящих HTTP/HTTPS запросов, маршрутизация, управление сессиями

Технологии: Библиотека civetweb (встроенный веб-сервер)

Особенности:

Поддержка только HTTPS (HTTP порт отключён)

HSTS заголовки для принудительного использования HTTPS

Security headers (XSS-Protection, Clickjacking protection)

Rate limiting на аутентификацию

DatabaseManager — менеджер базы данных
Назначение: Взаимодействие с БД, аутентификация, управление пользователями

Технологии: nanodbc (ODBC wrapper), MySQL/PostgreSQL через ODBC DSN

Особенности:

Потокобезопасность (мьютексы для разных операций)

Криптографически безопасные токены

Отслеживание подозрительной активности (IP/User-Agent изменения)

Автоматическая очистка устаревших токенов

PasswordHasher — модуль работы с паролями
Назначение: Безопасное хеширование и валидация паролей

Технологии: OpenSSL PBKDF2-HMAC-SHA256

Особенности:

Проверка сложности паролей (8+ символов, регистры, цифры, спецсимволы)

Защита от распространённых слабых паролей

Генерация безопасных случайных паролей

1.2. Схема взаимодействия
text
Клиент (POSTMAN/браузер)
        ↓
[ HTTPS → Port 8443s ]
        ↓
   ServerCore
        ↓
   (Маршрутизация)
        ↓
[Аутентификация → DatabaseManager]
        ↓
[Валидация пароля → PasswordHasher]
        ↓
   [Обработка запроса]
        ↓
   [Ответ в JSON]
1.3. Технологический стек
Язык и стандарт:
C++17

Чистый C++ (минимальные зависимости от Qt в ядре)

Библиотеки:
civetweb — встроенный веб-сервер

nanodbc — работа с базами данных через ODBC

OpenSSL — криптография (PBKDF2, SHA256)

JSONCpp — парсинг и генерация JSON

Qt — только для GUI (тестового интерфейса)

База данных:
Любая БД с ODBC драйвером (MySQL, PostgreSQL, SQL Server)

DSN: "GuarderDB"

Кодировка: utf8mb4_unicode_ci

Протоколы:
HTTPS только (TLS 1.2/1.3)

REST API (все запросы POST, JSON)

1.4. Принципы проектирования
Безопасность:
Все пароли хешируются PBKDF2 с уникальной солью

Токены имеют ограниченное время жизни (24 часа)

Проверка IP/User-Agent для обнаружения подозрительной активности

Защита от SQL-инъекций (параметризованные запросы)

XSS защита (экранирование HTML в JSON)

Надёжность:
Постоянное соединение с БД (connection pool)

Автоматическое восстановление при разрыве соединения

Логирование всех критических операций

Graceful shutdown

Масштабируемость:
Статическая архитектура (один экземпляр DatabaseManager)

Потокобезопасность через мьютексы

Возможность запуска нескольких экземпляров сервера на разных портах

1.5. Директории проекта
text
project/
├── src/
│   ├── servercore.cpp/h     # Ядро сервера
│   ├── databasemanager.cpp/h # Менеджер БД
│   ├── passwordhasher.cpp/h  # Хеширование паролей
│   └── civetweb/            # Встроенный веб-сервер
├── ssl_certs/
│   └── server.pem           # SSL сертификат
├── gui/                     # Тестовый GUI (Qt)
└── sql/
    └── create_tables.sql    # Структура БД
1.6. Жизненный цикл запроса
Получение HTTPS запроса на порт 8443

Извлечение токена из заголовка Authorization (Bearer)

Валидация токена через DatabaseManager (проверка срока, подозрительности)

Проверка прав доступа по роли пользователя

Обработка бизнес-логики (в зависимости от эндпоинта)

Формирование JSON ответа с security заголовками

Логирование операции для аудита

1.7. Ключевые особенности
Только HTTPS — HTTP порт отключён в целях безопасности

Self-contained — минимальные внешние зависимости

Кросс-платформенность — работает на Windows и Linux

Легковесность — один исполняемый файл + сертификат

Простая конфигурация — БД через ODBC DSN, сертификат рядом с .exe

1.8. Расположение SSL сертификата
Автоматическое определение пути:
Сервер автоматически ищет SSL сертификат в следующем порядке:

Рядом с исполняемым файлом в папке ssl_certs/:

text
/путь/к/серверу/
├── guarder_server.exe
└── ssl_certs/
    └── server.pem
Непосредственно рядом с исполняемым файлом:

text
/путь/к/серверу/
├── guarder_server.exe
└── server.pem
Код определения пути (кроссплатформенный):
cpp
// Windows: GetModuleFileNameA()
// Linux: readlink("/proc/self/exe")
// Если не находит - падает с понятной ошибкой
Требования к сертификату:
Формат: PEM (Privacy Enhanced Mail)

Содержимое: Приватный ключ и сертификат в одном файле

Имя файла: server.pem (фиксированное)

Размещение: В одной директории с .exe или в поддиректории ssl_certs/

Для автозапуска (служба/демон):
text
# Linux systemd service
/opt/guarder_server/
├── guarder_server
├── server.pem
└── ssl_certs/server.pem

# Windows Service
C:\Program Files\GuarderServer\
├── guarder_server.exe
├── server.pem
└── ssl_certs\server.pem
Проверка при старте:
При запуске сервер проверяет наличие сертификата и выводит понятную ошибку если файл не найден:

text
"SSL certificate file not found. Expected at: [полный_путь]"
Рекомендация для production:
Создать символическую ссылку или скопировать сертификат в оба места для гарантированной работы.


